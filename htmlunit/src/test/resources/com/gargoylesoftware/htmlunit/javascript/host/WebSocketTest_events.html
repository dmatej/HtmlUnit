<html>
<head>
<script>
    function $(id) {
        return document.getElementById(id);
    }
    

    // https://developers.google.com/web/updates/2012/06/How-to-convert-ArrayBuffer-to-and-from-String
    function ab2str(buf) {
        return String.fromCharCode.apply(null, new Uint16Array(buf));
    }

    function str2ab(str) {
        var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
        var bufView = new Uint16Array(buf);
        for (var i=0, strLen=str.length; i < strLen; i++) {
          bufView[i] = str.charCodeAt(i);
        }
        return buf;
    }

    var room = {
        init : function() {
            var location = "ws://localhost:12345/"
            this._ws = new WebSocket(location);
            this._ws.binaryType = 'arraybuffer';
            this._ws.addEventListener('open', this._onopen);
            this._ws.addEventListener('message', this._onmessage);
            this._ws.addEventListener('close', this._onclose);
            this._ws.onerror = this._onerror;
        },

        _onopen : function() {
            $('onOpen').className = '';
            room._send('text');
        },

        _onmessage : function(e) {
            if (e.data === 'server_text') {
                $('onMessageText').className = '';
                room._send(str2ab('binary'));
            }
            else if(ab2str(e.data) === 'server_binary'){
                $('onMessageBinary').className = '';
                room._send('close');
            }
            else {
                console.warn("Unknown message: ", e.data);
            }
        },

        _onclose : function(m) {
            this._ws = null;
            $('onClose').className = '';
        },

        _onerror : function(e) {
            alert(e);
        },
        
        _send: function(data) {
            this._ws.send(data);
        }
    };
    
    window.onload = function(){
        room.init();
    };
</script>

<style type='text/css'>
    div.hidden { display: none; }
</style>
</head>

<body>
    <div id="onOpen" class="hidden">onOpen</div>
    <div id="onMessageText" class="hidden">onMessageText</div>
    <div id="onMessageBinary" class="hidden">onMessageBinary</div>
    <div id="onClose" class="hidden">onClose</div>
</body>
</html>
